---
import { Image } from 'astro:assets'
import type { ImageMetadata } from 'astro'
import type { GalleryItem } from './types'

interface Props {
  items: GalleryItem[]
}

const { items } = Astro.props

const pageURL = Astro.url ?? Astro.site ?? null

const normaliseSource = (raw: string): string => {
  if (!raw) return ''
  if (/^(?:[a-z][a-z+\-.]*:)?\/\//i.test(raw) || raw.startsWith('/') || raw.startsWith('data:')) {
    return raw
  }

  if (pageURL) {
    try {
      return new URL(raw, pageURL).pathname
    } catch {
      return raw
    }
  }

  return raw
}

interface ResolvedItem extends GalleryItem {
  source: string
  metadata: ImageMetadata | null
}

const resolvedItems: ResolvedItem[] = items
  .map((item) => {
    if (typeof item.image === 'string') {
      return {
        ...item,
        source: normaliseSource(item.image),
        metadata: null
      }
    }

    const metadata = item.image ?? null
    const source = normaliseSource(metadata?.src ?? '')

    return {
      ...item,
      source,
      metadata
    }
  })
  .filter((item) => Boolean(item.source))
---

<div class='gallery-grid'>
  {resolvedItems.map((item) => (
    <figure class='gallery-card'>
      <a
        class='gallery-link'
        href={item.source}
        target='_blank'
        rel='noopener noreferrer'
      >
        {item.metadata ? (
          <Image
            src={item.metadata}
            loading='lazy'
            decoding='async'
            alt={item.title || 'Gallery photo'}
            class='gallery-image'
          />
        ) : (
          <img
            loading='lazy'
            decoding='async'
            src={item.source}
            alt={item.title || 'Gallery photo'}
            class='gallery-image'
          />
        )}
      </a>
      {(item.title || item.subtitle || item.description) && (
        <figcaption class='gallery-caption'>
          {item.subtitle && <span class='gallery-subtitle'>{item.subtitle}</span>}
          {item.title && <h3 class='gallery-title'>{item.title}</h3>}
          {item.description && <p class='gallery-description'>{item.description}</p>}
        </figcaption>
      )}
    </figure>
  ))}
</div>

<style>
  .gallery-grid {
    display: grid;
    gap: 1.5rem;
    grid-template-columns: repeat(1, minmax(0, 1fr));
  }

  @media (min-width: 640px) {
    .gallery-grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }

  .gallery-card {
    position: relative;
    overflow: hidden;
    border-radius: 28px;
    border: 1px solid rgba(255, 255, 255, 0.45);
    background: rgba(255, 255, 255, 0.72);
    box-shadow: 0 30px 80px -50px rgba(15, 23, 42, 0.55);
    transition: transform 500ms ease, box-shadow 500ms ease;
  }

  .gallery-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 40px 100px -55px rgba(15, 23, 42, 0.6);
  }

  .dark .gallery-card {
    border-color: rgba(255, 255, 255, 0.16);
    background: rgba(15, 23, 42, 0.35);
    box-shadow: 0 40px 110px -60px rgba(8, 16, 32, 0.7);
  }

  .gallery-link {
    display: block;
  }

  .gallery-image {
    width: 100%;
    height: 100%;
    display: block;
    object-fit: cover;
    aspect-ratio: 4 / 5;
  }

  .gallery-caption {
    padding: 1.25rem 1.5rem 1.75rem;
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
    background: linear-gradient(180deg, rgba(255, 255, 255, 0) 0%, rgba(248, 250, 252, 0.94) 60%);
  }

  .dark .gallery-caption {
    background: linear-gradient(180deg, rgba(15, 23, 42, 0) 0%, rgba(15, 23, 42, 0.72) 60%);
  }

  .gallery-subtitle {
    font-size: 0.68rem;
    letter-spacing: 0.4em;
    text-transform: uppercase;
    color: rgba(15, 23, 42, 0.55);
  }

  .dark .gallery-subtitle {
    color: rgba(255, 255, 255, 0.55);
  }

  .gallery-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: rgb(15, 23, 42);
  }

  .dark .gallery-title {
    color: rgb(255, 255, 255);
  }

  .gallery-description {
    font-size: 0.9rem;
    line-height: 1.5;
    color: rgba(15, 23, 42, 0.72);
  }

  .dark .gallery-description {
    color: rgba(226, 232, 240, 0.85);
  }
</style>
