---
import type { GalleryItem } from './types'

interface Props {
  items: GalleryItem[]
}

const { items } = Astro.props

const normalizedItems = items.map((item) => {
  const orientation =
    item.layout ??
    (item.width && item.height
      ? item.width >= item.height
        ? 'landscape'
        : 'portrait'
      : 'landscape')

  return { ...item, orientation }
})
---

<div class='gallery-grid' data-gallery-grid>
  {normalizedItems.map((item) => (
    <figure
      class={`gallery-card ${item.orientation === 'landscape' ? 'is-landscape' : 'is-portrait'}`}
      data-title={item.title ?? item.subtitle ?? ''}
      data-date={item.capturedAt ? Date.parse(item.capturedAt) : ''}
    >
      <a
        class='gallery-link'
        href={item.image}
        target='_blank'
        rel='noopener noreferrer'
        aria-label={`查看 ${item.title ?? '图片'} 的原图`}
      >
        <img
          loading='lazy'
          decoding='async'
          src={item.image}
          alt={item.title || 'Gallery photo'}
          class={`gallery-image ${item.orientation === 'landscape' ? 'is-landscape' : 'is-portrait'}`}
        />
      </a>
      {(item.title || item.subtitle || item.description) && (
        <figcaption class='gallery-caption'>
          {item.subtitle && <span class='gallery-subtitle'>{item.subtitle}</span>}
          {item.title && <h3 class='gallery-title'>{item.title}</h3>}
          {item.description && <p class='gallery-description'>{item.description}</p>}
        </figcaption>
      )}
    </figure>
  ))}
</div>

<script is:inline>
  const initGallerySorting = () => {
    const grid = document.querySelector('[data-gallery-grid]')
    const control = document.querySelector('[data-gallery-sort]')

    if (!(grid instanceof HTMLElement) || !(control instanceof HTMLSelectElement)) {
      return
    }

    const collator = new Intl.Collator('zh-Hans', { numeric: true, sensitivity: 'base' })

    const items = Array.from(grid.children)
      .filter((element) => element instanceof HTMLElement)
      .map((element) => {
        const rawDate = element.dataset.date
        return {
          element,
          title: (element.dataset.title ?? '').trim(),
          date: rawDate && rawDate.length > 0 ? Number(rawDate) : Number.NaN
        }
      })

    const applySort = (mode) => {
      const sorted = [...items]

      switch (mode) {
        case 'alpha-desc':
          sorted.sort((a, b) => collator.compare(b.title, a.title))
          break
        case 'time-asc':
          sorted.sort((a, b) => {
            const aTime = Number.isFinite(a.date) ? a.date : Number.POSITIVE_INFINITY
            const bTime = Number.isFinite(b.date) ? b.date : Number.POSITIVE_INFINITY
            return aTime - bTime
          })
          break
        case 'time-desc':
          sorted.sort((a, b) => {
            const aTime = Number.isFinite(a.date) ? a.date : Number.NEGATIVE_INFINITY
            const bTime = Number.isFinite(b.date) ? b.date : Number.NEGATIVE_INFINITY
            return bTime - aTime
          })
          break
        case 'alpha-asc':
        default:
          sorted.sort((a, b) => collator.compare(a.title, b.title))
          break
      }

      for (const { element } of sorted) {
        grid.append(element)
      }
    }

    applySort(control.value)
    control.addEventListener('change', () => applySort(control.value))
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initGallerySorting, { once: true })
  } else {
    initGallerySorting()
  }
</script>

<style>
  .gallery-grid {
    display: grid;
    gap: 1.5rem;
    grid-auto-flow: row;
    grid-template-columns: repeat(1, minmax(0, 1fr));
  }

  @media (min-width: 640px) {
    .gallery-grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }

  .gallery-card {
    position: relative;
    overflow: hidden;
    border-radius: 28px;
    border: 1px solid rgba(255, 255, 255, 0.45);
    background: rgba(255, 255, 255, 0.72);
    box-shadow: 0 30px 80px -50px rgba(15, 23, 42, 0.55);
    transition: transform 500ms ease, box-shadow 500ms ease;
  }

  .gallery-card.is-landscape {
    grid-column: span 1;
  }

  @media (min-width: 640px) {
    .gallery-card.is-landscape {
      grid-column: span 2;
    }
  }

  .gallery-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 40px 100px -55px rgba(15, 23, 42, 0.6);
  }

  .dark .gallery-card {
    border-color: rgba(255, 255, 255, 0.16);
    background: rgba(15, 23, 42, 0.35);
    box-shadow: 0 40px 110px -60px rgba(8, 16, 32, 0.7);
  }

  .gallery-link {
    display: block;
  }

  .gallery-image {
    width: 100%;
    height: 100%;
    display: block;
    object-fit: cover;
  }

  .gallery-image.is-portrait {
    aspect-ratio: 4 / 5;
  }

  .gallery-image.is-landscape {
    aspect-ratio: 3 / 2;
  }

  .gallery-caption {
    padding: 1.25rem 1.5rem 1.75rem;
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
    background: linear-gradient(180deg, rgba(255, 255, 255, 0) 0%, rgba(248, 250, 252, 0.94) 60%);
  }

  .dark .gallery-caption {
    background: linear-gradient(180deg, rgba(15, 23, 42, 0) 0%, rgba(15, 23, 42, 0.72) 60%);
  }

  .gallery-subtitle {
    font-size: 0.68rem;
    letter-spacing: 0.4em;
    text-transform: uppercase;
    color: rgba(15, 23, 42, 0.55);
  }

  .dark .gallery-subtitle {
    color: rgba(255, 255, 255, 0.55);
  }

  .gallery-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: rgb(15, 23, 42);
  }

  .dark .gallery-title {
    color: rgb(255, 255, 255);
  }

  .gallery-description {
    font-size: 0.9rem;
    line-height: 1.5;
    color: rgba(15, 23, 42, 0.72);
  }

  .dark .gallery-description {
    color: rgba(226, 232, 240, 0.85);
  }
</style>
